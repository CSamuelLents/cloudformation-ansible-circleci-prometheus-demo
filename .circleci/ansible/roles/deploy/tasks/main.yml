---
- name: Copy pm2 config
  copy:
    src: ecosystem.config.js
    dest: ~/ecosystem.config.js
    backup: yes

# - name: Copy application source
#   copy:
#     src: ~/project/backend/dist
#     dest: ~/backend
#     mode: 644
#     backup: yes

- name: Create codebase extraction target
  become: true
  file:
    path: /home/ubuntu/backend
    state: directory

- name: Extract backend to folder
  become: true
  unarchive:
    src: ~/project/backend.tar.gz
    dest: ~/backend
    owner: ubuntu
    group: ubuntu
    mode: 0755

- name: Execute Node application
  shell: pm2 startOrGracefulReload ~/ecosystem.config.js
  environment:
    ENVIRONMENT: production
    TYPEORM_CONNECTION: postgres
    TYPEORM_ENTITIES: ~/backend/dist/modules/domain/**/*.entity.js
    TYPEORM_PORT: 5532
    TYPEORM_HOST: lookup('env', 'TYPEORM_HOST')
    TYPEORM_USERNAME: lookup('env', 'TYPEORM_USERNAME')
    TYPEORM_PASSWORD: lookup('env', 'TYPEORM_PASSWORD')
    TYPEORM_DATABASE: lookup('env', 'TYPEORM_DATABASE')
